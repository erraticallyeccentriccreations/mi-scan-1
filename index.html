<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filament V21 (High Up)</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* 1. RESET: Remove all padding so it touches the edges */
        body { 
            background-color: #000; 
            color: #fff; 
            font-family: sans-serif; 
            text-align: center; 
            margin: 0; 
            padding: 0;
            overflow: hidden; /* Stop scrolling */
        }
        
        /* 2. SCANNER POSITION: Pinned to the very top */
        #scanner-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: #000;
        }

        /* 3. CAMERA WINDOW: Forced to only take up the top 45% of screen */
        #reader { 
            width: 100%; 
            height: 45vh; /* This forces the box high up */
            border-bottom: 4px solid #333; 
            background: #000; 
            overflow: hidden;
        }
        
        /* 4. STATUS TEXT: Big and right below the scanner */
        #status { 
            margin-top: 20px; 
            font-size: 1.5rem; 
            font-weight: bold; 
            min-height: 50px; 
            text-transform: uppercase;
        }
        
        .success { color: #0f0; transition: color 0.2s; }
        .idle { color: #888; }
        .error { color: #f00; display: none; margin-top: 20px; border: 1px solid red; padding: 10px;}

        /* 5. BUTTON: Centered in the middle of the screen */
        #start-btn { 
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px; 
            font-size: 1.3rem; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            width: 80%;
        }
    </style>
</head>
<body>

    <button id="start-btn" onclick="startScanner()">⚡ Start Scanner</button>

    <div id="scanner-container" style="display:none;">
        <div id="reader"></div>
        <div id="status" class="idle">Ready...</div>
        <div id="error-msg" class="error"></div>
    </div>

    <script>
        // ▼▼▼ YOUR WORKING URL ▼▼▼
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbySceeS-1b8bQ-RQXICYU-flzVlvCwSSBLXI-7Tyq1ct60QN1AcnvXqEPaig4xWo6cC/exec"; 
        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

        let html5QrcodeScanner;
        let lastScannedCode = null;
        let lastScannedTime = 0;

        function startScanner() {
            document.getElementById('start-btn').innerText = "Starting Camera...";
            
            setTimeout(() => {
                document.getElementById('start-btn').style.display = 'none';
                document.getElementById('scanner-container').style.display = 'block';

                try {
                    // CONFIG: Same V20 Engine
                    let config = {
                        fps: 30, 
                        qrbox: { width: 250, height: 100 }, 
                        formatsToSupport: [ 
                            Html5QrcodeSupportedFormats.CODE_128,
                            Html5QrcodeSupportedFormats.EAN_13,
                            Html5QrcodeSupportedFormats.UPC_A,
                            Html5QrcodeSupportedFormats.CODE_39
                        ],
                        videoConstraints: {
                            width: { min: 640, ideal: 1280, max: 1920 },
                            height: { min: 480, ideal: 720, max: 1080 },
                            facingMode: "environment",
                            focusMode: "continuous"
                        }
                    };

                    html5QrcodeScanner = new Html5QrcodeScanner("reader", config);
                    
                    html5QrcodeScanner.render(onScanSuccess, (err) => {});

                } catch (err) {
                    document.getElementById('error-msg').style.display = 'block';
                    document.getElementById('error-msg').innerText = "Error: " + err.message;
                }
            }, 100);
        }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = 'sawtooth'; 
            osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            gain.gain.setValueAtTime(1.0, audioCtx.currentTime);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        function onScanSuccess(decodedText, decodedResult) {
            const now = Date.now();

            // 1 SECOND COOLDOWN
            if (decodedText === lastScannedCode && (now - lastScannedTime) < 1000) {
                return; 
            }

            lastScannedCode = decodedText;
            lastScannedTime = now;

            playBeep();
            
            const statusEl = document.getElementById('status');
            statusEl.innerText = "SAVED: " + decodedText;
            statusEl.className = "success";

            fetch(`${SCRIPT_URL}?barcode=${encodeURIComponent(decodedText)}&qty=1`, { mode: 'no-cors' })
            .catch(err => console.error(err));

            setTimeout(() => { 
                statusEl.innerText = "Ready..."; 
                statusEl.className = "idle";
            }, 1000);
        }
    </script>
</body>
</html>
