<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Filament Scanner</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body { background:#000; color:#fff; font-family:sans-serif; margin:0; text-align:center; }

#controls {
  position:fixed;
  top:0;
  width:100%;
  background:#000;
  z-index:9999;
  padding:10px;
}

button {
  width:90%;
  max-width:340px;
  padding:16px;
  margin:6px auto;
  font-size:1.1rem;
  border:none;
  border-radius:8px;
  cursor:pointer;
}

#start-btn { background:#007bff; color:#fff; }
#clear-btn { background:#dc3545; color:#fff; }
#view-btn  { background:#28a745; color:#fff; }

#scanner-container {
  margin-top:220px;
  display:none;
}

#reader {
  border:2px solid #333;
  min-height:260px;
}

#status {
  margin-top:15px;
  font-size:1.4rem;
  min-height:40px;
}

.success { color:#00ff00; }
.idle { color:#888; }
</style>
</head>

<body>

<div id="controls">
  <button onclick="startScanner()">âš¡ Start Scanner</button>
  <button onclick="clearInventory()">ðŸ§¹ Clear Inventory</button>
  <button onclick="viewInventory()">ðŸ“‹ View Inventory</button>
</div>

<div id="scanner-container">
  <div id="reader"></div>
  <div id="status" class="idle">Loading productsâ€¦</div>
</div>

<script>
const SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbySceeS-1b8bQ-RQXICYU-flzVlvCwSSBLXI-7Tyq1ct60QN1AcnvXqEPaig4xWo6cC/exec";

const INVENTORY_URL =
"https://docs.google.com/spreadsheets/d/1JGgkmJw-ZomVjKmLauKJ8V070_Vhx-97WvdhHLCJrmc/edit";

const PRODUCTS_CSV_URL =
"https://docs.google.com/spreadsheets/d/1JGgkmJw-ZomVjKmLauKJ8V070_Vhx-97WvdhHLCJrmc/export?format=csv&gid=1242803893";

/* ðŸ”Š VERY LOUD BEEP */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function loudBeep() {
  if (audioCtx.state === "suspended") audioCtx.resume();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = "sawtooth";
  o.frequency.value = 900;
  g.gain.value = 1.3;
  o.connect(g);
  g.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + 0.12);
}

/* SAFE CSV PARSER */
function parseCSV(text) {
  const rows = [];
  let row=[], val="", q=false;
  for (let c of text) {
    if (c === '"') q = !q;
    else if (c === ',' && !q) { row.push(val); val=""; }
    else if (c === '\n' && !q) { row.push(val); rows.push(row); row=[]; val=""; }
    else val += c;
  }
  if (val) row.push(val);
  return rows;
}

/* PRODUCT LOOKUP */
const products = {};

fetch(PRODUCTS_CSV_URL)
.then(r => r.text())
.then(csv => {
  const rows = parseCSV(csv);
  rows.slice(1).forEach(r => {
    const barcode = r[0]?.trim();
    const color   = r[4]?.trim(); // âœ… CORRECT: Column E
    if (barcode && color) products[barcode] = color;
  });
  document.getElementById("status").textContent = "Ready...";
});

/* SCANNER */
let lastCode=null, lastTime=0, scanner;

function startScanner() {
  document.getElementById("scanner-container").style.display="block";
  scanner = new Html5QrcodeScanner("reader", {
    fps:30,
    qrbox:{width:250,height:100},
    videoConstraints:{facingMode:"environment"}
  });
  scanner.render(onScanSuccess, ()=>{});
}

function onScanSuccess(code) {
  const now = Date.now();
  if (code === lastCode && now - lastTime < 1000) return;
  lastCode = code;
  lastTime = now;

  loudBeep();

  const color = products[code] || "UNKNOWN";

  fetch(
    `${SCRIPT_URL}?barcode=${encodeURIComponent(code)}&color=${encodeURIComponent(color)}`,
    { mode:"no-cors" }
  );

  const s = document.getElementById("status");
  s.textContent = `SAVED: ${color}`;
  s.className = "success";

  setTimeout(() => {
    s.textContent = "Ready...";
    s.className = "idle";
  }, 1200);
}

/* BUTTONS */
function clearInventory() {
  if (confirm("Clear inventory?"))
    fetch(`${SCRIPT_URL}?action=clear`, { mode:"no-cors" });
}

function viewInventory() {
  window.open(INVENTORY_URL, "_blank");
}
</script>
</body>
</html>
