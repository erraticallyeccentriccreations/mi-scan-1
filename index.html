<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scanner</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body { margin:0; background:#000; color:#fff; font-family:sans-serif; text-align:center; }
button {
  width:90%; max-width:360px;
  padding:16px; margin:8px;
  font-size:1.2rem; border:none; border-radius:8px;
}
#controls { position:fixed; top:0; width:100%; background:#000; z-index:10; padding:10px; }
#scanner { margin-top:240px; display:none; }
#status { font-size:1.6rem; margin-top:15px; min-height:40px; }
</style>
</head>

<body>

<div id="controls">
  <button onclick="start()">â–¶ Start Scanning</button>
  <button onclick="clearInventory()">ðŸ§¹ Clear Inventory</button>
  <button onclick="openInventory()">ðŸ“‹ View Inventory</button>
</div>

<div id="scanner">
  <div id="reader"></div>
  <div id="status">Loading productsâ€¦</div>
</div>

<script>
const SCRIPT =
"https://script.google.com/macros/s/AKfycbySceeS-1b8bQ-RQXICYU-flzVlvCwSSBLXI-7Tyq1ct60QN1AcnvXqEPaig4xWo6cC/exec";

const INVENTORY =
"https://docs.google.com/spreadsheets/d/1JGgkmJw-ZomVjKmLauKJ8V070_Vhx-97WvdhHLCJrmc/edit";

const PRODUCTS =
"https://docs.google.com/spreadsheets/d/1JGgkmJw-ZomVjKmLauKJ8V070_Vhx-97WvdhHLCJrmc/export?format=csv&gid=1242803893";

let products = {};
let locked = false;
let scanner;

/* VERY LOUD BEEP */
const ctx = new (window.AudioContext || window.webkitAudioContext)();
function beep() {
  if (ctx.state === "suspended") ctx.resume();
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.frequency.value = 1000;
  g.gain.value = 1.4;
  o.connect(g); g.connect(ctx.destination);
  o.start(); o.stop(ctx.currentTime + 0.15);
}

/* CSV PARSER */
function parseCSV(t) {
  return t.trim().split("\n").slice(1).map(r => r.split(","));
}

/* LOAD PRODUCTS */
fetch(PRODUCTS)
.then(r => r.text())
.then(t => {
  parseCSV(t).forEach(r => {
    const barcode = String(r[0]).trim();
    const color   = String(r[4]).trim();
    if (barcode && color) products[barcode] = color;
  });
  document.getElementById("status").textContent = "Ready";
});

/* START */
function start() {
  document.getElementById("scanner").style.display="block";
  scanner = new Html5Qrcode("reader");
  scanner.start(
    { facingMode:"environment" },
    { fps:30, qrbox:{ width:250, height:100 } },
    onScan
  );
}

/* SCAN HANDLER */
function onScan(code) {
  if (locked) return;
  locked = true;

  code = String(code).trim();
  const color = products[code] || "UNKNOWN";

  beep();

  document.getElementById("status").textContent =
    `Saved: ${color}`;

  fetch(
    `${SCRIPT}?barcode=${encodeURIComponent(code)}&color=${encodeURIComponent(color)}`,
    { mode:"no-cors" }
  );

  setTimeout(() => locked = false, 900);
}

/* BUTTONS */
function clearInventory() {
  if (confirm("Clear inventory?"))
    fetch(`${SCRIPT}?action=clear`, { mode:"no-cors" });
}

function openInventory() {
  window.open(INVENTORY, "_blank");
}
</script>
</body>
</html>
