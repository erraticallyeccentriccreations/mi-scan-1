<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scanner</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>

<style>
  body { 
    margin: 0; background: #000; color: #fff; font-family: sans-serif; 
    text-align: center; padding-bottom: 220px; 
  }

  /* BUTTON STYLES */
  #controls { 
    position: fixed; bottom: 0; left: 0; width: 100%; 
    background: #000; z-index: 1000; padding: 10px 0; 
    border-top: 1px solid #333;
    padding-bottom: env(safe-area-inset-bottom);
    display: flex; flex-wrap: wrap; justify-content: center; gap: 8px;
  }

  button.main-btn { 
    width: 45%; max-width: 180px; 
    padding: 12px; font-size: 1rem; border: none; 
    border-radius: 8px; cursor: pointer; font-weight: bold; 
  }
  button.full-width { width: 92%; max-width: 380px; }
  
  button:active { opacity: 0.8; transform: scale(0.98); }

  /* SCANNER POSITION */
  #scanner { width: 100%; margin-top: 0; display: none; position: relative; z-index: 1; }
  #status { margin-top: 10px; font-size: 1.1rem; color: #aaa; z-index: 5; }

  /* NOTIFICATIONS */
  #notification {
    position: fixed; top: 30px; left: 50%; transform: translateX(-50%);
    width: 90%; font-size: 2rem; font-weight: bold; text-align: center;
    opacity: 0; transition: opacity 0.2s ease-in-out; pointer-events: none; 
    z-index: 2000; text-shadow: 0px 3px 8px rgba(0,0,0,1);
    white-space: pre-wrap; 
  }
  
  .success-text { color: #00ff00; } 
  .error-text   { color: #ff3333; } 
  .info-text    { color: #007bff; font-size: 1.5rem; } 

</style>
</head>

<body>

<div id="notification"></div>

<div id="scanner">
  <div id="reader"></div>
  <div id="status">Loading data...</div>
</div>

<div id="controls">
  <button class="main-btn" id="flash-btn" onclick="toggleFlash()" style="background:#555; color:#fff;">ðŸ”¦ Light</button>
  <button class="main-btn" onclick="switchCamera()" style="background:#6f42c1; color:#fff;">ðŸ“· Switch Cam</button>
  
  <button class="main-btn full-width" id="btn-scan-toggle" onclick="toggleScan()" style="background:#28a745; color:#fff;">â–¶ Start Scanning</button>
  
  <button class="main-btn" onclick="clearInventory()" style="background:#dc3545; color:#fff;">ðŸ§¹ Clear</button>
  <button class="main-btn" onclick="openInventory()" style="background:#007bff; color:#fff;">ðŸ“‹ View</button>
</div>

<script>
// --- CONFIGURATION --- //
const SCRIPT = "https://script.google.com/macros/s/AKfycbySceeS-1b8bQ-RQXICYU-flzVlvCwSSBLXI-7Tyq1ct60QN1AcnvXqEPaig4xWo6cC/exec";
const INVENTORY = "https://docs.google.com/spreadsheets/d/1JGgkmJw-ZomVjKmLauKJ8V070_Vhx-97WvdhHLCJrmc/edit";
const PRODUCTS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWWQ0TK82bgpkiJkrj71ZXODJ7nnlyvSBKmlYJhEoF3JCgfkSy0_Wjjxlw_g-JQIDiDvANZ-p7HXUa/pub?gid=1242803893&single=true&output=csv";
// --------------------- //

let products = {};
let scanner = null; // Scanner Object
let locked = false;
let audioCtx = null;
let isFlashOn = false; 
let isScanning = false;
let cameras = [];      
let currentCamIndex = 0;

/* SOUND */
function beep() {
  try {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.frequency.value = 1000;
    g.gain.value = 1.0;
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + 0.15);
  } catch (e) { console.log("Audio silent"); }
}

/* CLEANER */
function clean(str) {
  if (!str) return "";
  str = String(str).trim();
  if (str.startsWith('"') && str.endsWith('"')) str = str.slice(1, -1);
  return str.trim();
}

/* LOAD DATA */
fetch(PRODUCTS_URL + "&t=" + Date.now())
  .then(r => r.text())
  .then(t => {
    const rows = t.split("\n").slice(1);
    let count = 0;
    rows.forEach(row => {
      const cols = row.split(",");
      if (cols.length > 4) {
        const barcode = clean(cols[0]);
        if (barcode) { 
          products[barcode] = {
            brand:    clean(cols[1]),
            material: clean(cols[2]),
            type:     clean(cols[3]),
            color:    clean(cols[4])
          };
          count++; 
        }
      }
    });
    document.getElementById("status").textContent = `Ready (${count} products)`;
  });

/* SETUP CAMERAS */
Html5Qrcode.getCameras().then(devices => {
  if (devices && devices.length) {
    cameras = devices;
    // Attempt to find the "Back" camera to start
    const backCam = cameras.findIndex(c => c.label.toLowerCase().includes('back'));
    if (backCam !== -1) currentCamIndex = backCam;
  }
}).catch(err => console.log("Cam error", err));

/* TOGGLE SCAN (START / STOP) */
function toggleScan() {
  const btn = document.getElementById("btn-scan-toggle");
  
  if (isScanning) {
    stopScanner(); // Stop
  } else {
    startScanner(); // Start
  }
}

/* START LOGIC */
function startScanner() {
  document.getElementById("scanner").style.display = "block";
  if (!audioCtx) try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {} 
  
  // Decide which camera to use
  let camId = null;
  if (cameras.length > 0) {
    camId = cameras[currentCamIndex].id;
  }
  
  // Initialize instance if null
  if (!scanner) {
    scanner = new Html5Qrcode("reader");
  }

  const config = { fps: 30, qrbox: { width: 250, height: 100 } };
  
  // Reset Flash UI
  isFlashOn = false;
  updateFlashBtn();

  // If we have an ID, use it. Else use "environment" (default back)
  const startPromise = camId ? scanner.start(camId, config, onScan) : scanner.start({ facingMode: "environment" }, config, onScan);

  startPromise.then(() => {
    isScanning = true;
    const btn = document.getElementById("btn-scan-toggle");
    btn.innerHTML = "â¹ Stop Camera";
    btn.style.background = "#dc3545"; // Red
  }).catch(err => {
    console.error(err);
    alert("Camera failed to start. Refresh page.");
  });
}

/* STOP LOGIC */
function stopScanner() {
  if (scanner && isScanning) {
    scanner.stop().then(() => {
      // Clear the element to remove the frozen image
      scanner.clear();
      isScanning = false;
      const btn = document.getElementById("btn-scan-toggle");
      btn.innerHTML = "â–¶ Start Scanning";
      btn.style.background = "#28a745"; // Green
      document.getElementById("scanner").style.display = "none";
      
      // Reset Flash UI
      isFlashOn = false;
      updateFlashBtn();
    }).catch(err => console.log("Stop failed", err));
  }
}

/* SWITCH CAMERA (AGGRESSIVE) */
function switchCamera() {
  if (cameras.length < 2) {
    showNotification("Only 1 Cam Found", "error-text");
    return;
  }
  
  // 1. Move to next index
  currentCamIndex = (currentCamIndex + 1) % cameras.length;
  
  // 2. Get Name
  let camLabel = cameras[currentCamIndex].label || ("Camera " + (currentCamIndex + 1));
  camLabel = camLabel.split('(')[0].trim(); // Cleanup name
  showNotification(camLabel, "info-text");

  // 3. IF running, RESTART completely
  if (isScanning) {
    // STOP first
    scanner.stop().then(() => {
       scanner.clear();
       isScanning = false;
       // Short delay to let hardware release
       setTimeout(() => {
         startScanner();
       }, 200);
    }).catch(err => {
       // If stop fails, try forcing start anyway
       startScanner();
    });
  }
}

/* FLASHLIGHT */
function toggleFlash() {
  const video = document.querySelector("#scanner video");
  if (!video || !video.srcObject) return;
  const track = video.srcObject.getVideoTracks()[0];
  if (!track) return;

  isFlashOn = !isFlashOn;

  track.applyConstraints({ advanced: [{ torch: isFlashOn }] })
  .then(() => updateFlashBtn())
  .catch(err => {
      // Fallback
      track.applyConstraints({ torch: isFlashOn })
      .then(() => updateFlashBtn())
      .catch(e => {
         showNotification("Light Blocked", "error-text");
         isFlashOn = !isFlashOn; 
         updateFlashBtn();
      });
  });
}

function updateFlashBtn() {
    const btn = document.getElementById("flash-btn");
    if (isFlashOn) {
      btn.innerHTML = "ðŸ”¦ Light: ON";
      btn.style.background = "#ffc107"; btn.style.color = "#000";
    } else {
      btn.innerHTML = "ðŸ”¦ Light";
      btn.style.background = "#555"; btn.style.color = "#fff";
    }
}

/* SCAN HANDLER */
function onScan(code) {
  if (locked) return;
  locked = true;
  code = clean(code);
  
  let item = products[code];
  if (!item) item = products["0" + code];
  if (!item && code.startsWith("0")) item = products[code.substring(1)];

  const color    = item ? item.color    : "UNKNOWN";
  const brand    = item ? item.brand    : "";
  const material = item ? item.material : "";
  const type     = item ? item.type     : "";

  beep();
  showNotification(color, color === "UNKNOWN" ? "error-text" : "success-text");

  const url = `${SCRIPT}?barcode=${encodeURIComponent(code)}` +
              `&color=${encodeURIComponent(color)}` +
              `&brand=${encodeURIComponent(brand)}` +
              `&material=${encodeURIComponent(material)}` +
              `&type=${encodeURIComponent(type)}`;

  fetch(url, { mode: "no-cors" });
  
  setTimeout(() => { locked = false; }, 1500);
}

function showNotification(msg, cssClass) {
  const el = document.getElementById("notification");
  el.textContent = msg;
  el.style.opacity = "1";
  el.className = cssClass || "success-text"; 
  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(() => { el.style.opacity = "0"; }, 2000);
}

function clearInventory() {
  if (confirm("Clear inventory?")) {
    fetch(`${SCRIPT}?action=clear`, { mode: "no-cors" });
    showNotification("Inventory Cleared", "success-text");
  }
}
function openInventory() { window.open(INVENTORY, "_blank"); }
let toastTimeout;
</script>
</body>
</html>
