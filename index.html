<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scanner</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
  body { margin:0; background:#000; color:#fff; font-family:sans-serif; text-align:center; }

  /* BUTTON STYLES */
  button.main-btn { 
    width:90%; max-width:360px; 
    padding:18px; margin:10px auto; 
    font-size:1.3rem; border:none; border-radius:10px; 
    cursor:pointer; font-weight: bold; display: block;
  }
  button:active { opacity: 0.8; transform: scale(0.98); }

  #controls { 
    position:fixed; top:0; left:0; width:100%; 
    background:#000; z-index:10; padding:10px 0; 
  }

  /* Scanner Position */
  #scanner { margin-top:240px; display:none; }
  
  #status { margin-top: 15px; font-size: 1.2rem; color: #aaa; }

  /* FLOATING TEXT (No Background) */
  #notification {
    position: fixed;
    top: 180px; /* Positioned above scanner */
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    font-size: 2.5rem; /* Big Text */
    font-weight: bold;
    text-align: center;
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
    pointer-events: none;
    z-index: 100;
    text-shadow: 0px 2px 5px rgba(0,0,0,1); /* Shadow for contrast */
  }
  
  /* Text Colors */
  .success-text { color: #00ff00; } /* Bright Green */
  .error-text   { color: #ff3333; } /* Red (for unknown) */

</style>
</head>

<body>

<div id="controls">
  <button class="main-btn" onclick="start()" style="background:#28a745; color:#fff;">â–¶ Start Scanning</button>
  <button class="main-btn" onclick="clearInventory()" style="background:#dc3545; color:#fff;">ðŸ§¹ Clear Inventory</button>
  <button class="main-btn" onclick="openInventory()" style="background:#007bff; color:#fff;">ðŸ“‹ View Inventory</button>
</div>

<div id="notification"></div>

<div id="scanner">
  <div id="reader"></div>
  <div id="status">Loading data...</div>
</div>

<script>
// --- CONFIGURATION --- //
const SCRIPT = "https://script.google.com/macros/s/AKfycbySceeS-1b8bQ-RQXICYU-flzVlvCwSSBLXI-7Tyq1ct60QN1AcnvXqEPaig4xWo6cC/exec";
const INVENTORY = "https://docs.google.com/spreadsheets/d/1JGgkmJw-ZomVjKmLauKJ8V070_Vhx-97WvdhHLCJrmc/edit";
const PRODUCTS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWWQ0TK82bgpkiJkrj71ZXODJ7nnlyvSBKmlYJhEoF3JCgfkSy0_Wjjxlw_g-JQIDiDvANZ-p7HXUa/pub?gid=1242803893&single=true&output=csv";
// --------------------- //

let products = {};
let scanner;
let locked = false;
let audioCtx = null;

/* SOUND FUNCTION */
function beep() {
  try {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume();
    
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.frequency.value = 1000;
    g.gain.value = 1.0;
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + 0.15);
  } catch (e) { console.log("Audio silent"); }
}

/* DATA CLEANER */
function clean(str) {
  if (!str) return "";
  str = String(str).trim();
  if (str.startsWith('"') && str.endsWith('"')) str = str.slice(1, -1);
  return str.trim();
}

/* LOAD PRODUCTS */
fetch(PRODUCTS_URL + "&t=" + Date.now())
  .then(r => r.text())
  .then(t => {
    const rows = t.split("\n").slice(1);
    let count = 0;
    rows.forEach(row => {
      const cols = row.split(",");
      if (cols.length > 4) {
        const barcode = clean(cols[0]);
        const color = clean(cols[4]);
        if (barcode) {
          products[barcode] = color;
          count++;
        }
      }
    });
    console.log("Loaded products:", count);
    document.getElementById("status").textContent = `Ready (${count} products loaded)`;
  })
  .catch(e => {
    document.getElementById("status").textContent = "Error loading product list.";
  });

/* START CAMERA */
function start() {
  document.getElementById("scanner").style.display = "block";
  
  if (!audioCtx) { try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {} }
  if (scanner) return; 

  scanner = new Html5Qrcode("reader");
  scanner.start(
    { facingMode: "environment" },
    { fps: 30, qrbox: { width: 250, height: 100 } },
    onScan
  ).catch(err => alert("Camera Error: " + err));
}

/* SCAN HANDLER */
function onScan(code) {
  if (locked) return;
  locked = true;

  code = clean(code);
  
  let color = products[code];
  if (!color) color = products["0" + code];
  if (!color && code.startsWith("0")) color = products[code.substring(1)];

  const displayColor = color || "UNKNOWN";
  
  beep();
  showNotification(displayColor);

  fetch(`${SCRIPT}?barcode=${encodeURIComponent(code)}&color=${encodeURIComponent(displayColor)}`, { mode: "no-cors" });

  setTimeout(() => { locked = false; }, 1500);
}

/* NOTIFICATION LOGIC */
let toastTimeout;
function showNotification(msg) {
  const el = document.getElementById("notification");
  
  el.textContent = msg;
  el.style.opacity = "1";
  
  // Green text for success, Red for unknown
  el.className = (msg === "UNKNOWN") ? "error-text" : "success-text";

  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(() => {
    el.style.opacity = "0";
  }, 2000);
}

/* BUTTONS */
function clearInventory() {
  if (confirm("Delete all inventory data?")) {
    fetch(`${SCRIPT}?action=clear`, { mode: "no-cors" });
    showNotification("Inventory Cleared");
  }
}
function openInventory() {
  window.open(INVENTORY, "_blank");
}
</script>
</body>
</html>
