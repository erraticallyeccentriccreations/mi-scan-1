<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scanner</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body { margin:0; background:#000; color:#fff; font-family:sans-serif; text-align:center; }
button { 
  width:90%; max-width:360px; 
  padding:16px; margin:8px; 
  font-size:1.2rem; border:none; border-radius:8px; 
  cursor:pointer;
}
button:active { opacity: 0.8; }
#controls { position:fixed; top:0; width:100%; background:#000; z-index:10; padding:10px; box-sizing:border-box; }
#scanner { margin-top:240px; display:none; }
#status { font-size:1.4rem; margin-top:15px; min-height:40px; font-weight:bold; white-space: pre-wrap; }
#debug { font-size: 0.8rem; color: #888; margin-top: 5px; }
</style>
</head>

<body>

<div id="controls">
  <button onclick="start()" style="background:#28a745; color:#fff;">â–¶ Start Scanning</button>
  <button onclick="clearInventory()" style="background:#dc3545; color:#fff;">ðŸ§¹ Clear Inventory</button>
  <button onclick="openInventory()" style="background:#007bff; color:#fff;">ðŸ“‹ View Inventory</button>
</div>

<div id="scanner">
  <div id="reader"></div>
  <div id="status">Loading productsâ€¦</div>
  <div id="debug"></div>
</div>

<script>
// --- CONFIGURATION --- //

const SCRIPT =
"https://script.google.com/macros/s/AKfycbySceeS-1b8bQ-RQXICYU-flzVlvCwSSBLXI-7Tyq1ct60QN1AcnvXqEPaig4xWo6cC/exec";

const INVENTORY =
"https://docs.google.com/spreadsheets/d/1JGgkmJw-ZomVjKmLauKJ8V070_Vhx-97WvdhHLCJrmc/edit";

const PRODUCTS =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vRWWQ0TK82bgpkiJkrj71ZXODJ7nnlyvSBKmlYJhEoF3JCgfkSy0_Wjjxlw_g-JQIDiDvANZ-p7HXUa/pub?gid=1242803893&single=true&output=csv";

// --------------------- //

let products = {};
let locked = false;
let scanner;

/* SOUND EFFECT */
const ctx = new (window.AudioContext || window.webkitAudioContext)();
function beep() {
  if (ctx.state === "suspended") ctx.resume();
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.frequency.value = 1000;
  g.gain.value = 1.4;
  o.connect(g); g.connect(ctx.destination);
  o.start(); o.stop(ctx.currentTime + 0.15);
}

/* ROBUST CLEANER */
// Removes spaces AND quotes (e.g., " 123 " or "123" becomes 123)
function clean(str) {
  if (!str) return "";
  str = str.trim();
  if (str.startsWith('"') && str.endsWith('"')) {
    str = str.slice(1, -1);
  }
  return str.trim();
}

/* LOAD PRODUCTS */
fetch(PRODUCTS)
.then(r => r.text())
.then(t => {
  const rows = t.split("\n").slice(1); // Skip header
  let count = 0;
  
  rows.forEach(row => {
    // Simple split by comma (assuming no commas INSIDE the color names)
    // If your CSV has commas inside names, we need a regex parser, but this usually works.
    const columns = row.split(",");
    
    if (columns.length > 4) {
      // Index 0 = Barcode, Index 4 = Color
      const barcode = clean(columns[0]);
      const color   = clean(columns[4]);
      
      if (barcode && color) {
        products[barcode] = color;
        count++;
      }
    }
  });
  console.log(`Loaded ${count} products.`);
  document.getElementById("status").textContent = "Ready to Scan";
})
.catch(e => {
  document.getElementById("status").textContent = "Error loading list";
  console.error(e);
});

/* START CAMERA */
function start() {
  document.getElementById("scanner").style.display="block";
  if (scanner) return; 
  
  scanner = new Html5Qrcode("reader");
  scanner.start(
    { facingMode:"environment" },
    { fps:30, qrbox:{ width:250, height:150 } },
    onScan
  ).catch(err => {
    alert("Camera failed. Check permissions.");
  });
}

/* SCAN HANDLER */
function onScan(code) {
  if (locked) return;
  locked = true;

  // 1. Clean the scanned code
  code = clean(String(code));
  
  // 2. Try strict match
  let color = products[code];
  
  // 3. Try "Zero Correction" (Scanner reads 850, CSV has 0850)
  if (!color) color = products["0" + code];
  
  // 4. Try "Reverse Zero Correction" (Scanner reads 0850, CSV has 850)
  if (!color && code.startsWith("0")) color = products[code.substring(1)];

  // Fallback
  const displayColor = color || "UNKNOWN";
  
  beep();

  // Show status with Debug info if unknown
  const debugText = (displayColor === "UNKNOWN") ? `\n(Code: ${code})` : "";
  document.getElementById("status").textContent = `Saved: ${displayColor}${debugText}`;

  // Send to Google Sheets
  // We send the FOUND color (or UNKNOWN) to the sheet
  fetch(
    `${SCRIPT}?barcode=${encodeURIComponent(code)}&color=${encodeURIComponent(displayColor)}`,
    { mode:"no-cors" }
  );

  setTimeout(() => locked = false, 1500);
}

/* BUTTONS */
function clearInventory() {
  if (confirm("Clear inventory?")) {
    fetch(`${SCRIPT}?action=clear`, { mode:"no-cors" });
    document.getElementById("status").textContent = "Inventory Cleared";
  }
}

function openInventory() {
  window.open(INVENTORY, "_blank");
}
</script>
</body>
</html>
