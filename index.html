<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Filament V22 (Split Screen)</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* 1. LAYOUT: Split the screen into two vertical halves */
        body { 
            background-color: #000; 
            color: #fff; 
            font-family: sans-serif; 
            margin: 0; 
            padding: 0;
            height: 100vh; /* Fill phone screen */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* 2. TOP HALF: Camera Container (50% Height) */
        #scanner-container {
            width: 100%;
            height: 50vh; /* Camera takes exactly top half */
            background: #000;
            position: relative;
            overflow: hidden;
            border-bottom: 2px solid #333;
        }

        #reader { 
            width: 100%; 
            height: 100%; 
            border: none;
        }
        
        /* Fix video filling the space */
        #reader video {
            object-fit: cover;
            width: 100% !important;
            height: 100% !important;
        }

        /* 3. BOTTOM HALF: Status Area (50% Height) */
        #status-area {
            height: 50vh;
            display: flex;
            flex-direction: column;
            justify-content: center; /* Center text vertically */
            align-items: center;
            padding: 20px;
            text-align: center;
            background: #111;
        }

        /* Big Status Text */
        #status { 
            font-size: 2rem; 
            font-weight: bold; 
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        #last-scanned {
            font-size: 1.2rem;
            color: #888;
        }

        .success { color: #0f0; transition: color 0.1s; }
        .idle { color: #555; }
        .error { color: #f00; font-size: 0.8rem; margin-top: 10px;}

        /* Start Button Centered in Status Area initially */
        #start-btn { 
            padding: 20px 40px; 
            font-size: 1.3rem; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            width: 80%;
        }
    </style>
</head>
<body>

    <div id="scanner-container">
        <div id="reader"></div>
    </div>

    <div id="status-area">
        <button id="start-btn" onclick="startScanner()">⚡ Start Scanner</button>
        
        <div id="status-text-wrapper" style="display:none;">
            <div id="status" class="idle">Ready...</div>
            <div id="last-scanned">Waiting for scan</div>
        </div>
        
        <div id="error-msg" class="error"></div>
    </div>

    <script>
        // ▼▼▼ YOUR WORKING URL ▼▼▼
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbySceeS-1b8bQ-RQXICYU-flzVlvCwSSBLXI-7Tyq1ct60QN1AcnvXqEPaig4xWo6cC/exec"; 
        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

        let html5QrcodeScanner;
        let lastScannedCode = null;
        let lastScannedTime = 0;

        function startScanner() {
            document.getElementById('start-btn').innerText = "Starting...";
            
            setTimeout(() => {
                document.getElementById('start-btn').style.display = 'none';
                document.getElementById('status-text-wrapper').style.display = 'block';

                try {
                    let config = {
                        fps: 30, 
                        qrbox: { width: 250, height: 100 }, 
                        formatsToSupport: [ 
                            Html5QrcodeSupportedFormats.CODE_128,
                            Html5QrcodeSupportedFormats.EAN_13,
                            Html5QrcodeSupportedFormats.UPC_A,
                            Html5QrcodeSupportedFormats.CODE_39
                        ],
                        videoConstraints: {
                            facingMode: "environment",
                            focusMode: "continuous"
                        }
                    };

                    html5QrcodeScanner = new Html5QrcodeScanner("reader", config);
                    
                    html5QrcodeScanner.render(onScanSuccess, (err) => {});

                } catch (err) {
                    document.getElementById('error-msg').innerText = err.message;
                    document.getElementById('error-msg').style.display = 'block';
                }
            }, 100);
        }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = 'sawtooth'; 
            osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            gain.gain.setValueAtTime(1.0, audioCtx.currentTime);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        function onScanSuccess(decodedText, decodedResult) {
            const now = Date.now();

            // 1 SECOND COOLDOWN
            if (decodedText === lastScannedCode && (now - lastScannedTime) < 1000) {
                return; 
            }

            lastScannedCode = decodedText;
            lastScannedTime = now;

            playBeep();
            
            const statusEl = document.getElementById('status');
            const subStatusEl = document.getElementById('last-scanned');
            
            statusEl.innerText = "SAVED!";
            statusEl.className = "success";
            subStatusEl.innerText = decodedText;

            fetch(`${SCRIPT_URL}?barcode=${encodeURIComponent(decodedText)}&qty=1`, { mode: 'no-cors' })
            .catch(err => console.error(err));

            setTimeout(() => { 
                statusEl.innerText = "Ready..."; 
                statusEl.className = "idle";
            }, 1000);
        }
    </script>
</body>
</html>
