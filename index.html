<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>Scanner</title>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<link rel="apple-touch-icon" href="icon.png">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>

<style>
  body { 
    margin: 0; background: #000; color: #fff; font-family: sans-serif; 
    text-align: center; padding-bottom: 220px; 
    /* Prevent pull-to-refresh on mobile */
    overscroll-behavior-y: contain; 
  }

  /* MODALS */
  .modal-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 5000;
    align-items: center; justify-content: center;
  }
  .modal-box {
    background: #222; padding: 20px; border-radius: 12px;
    width: 90%; max-width: 400px; border: 1px solid #444;
    text-align: left;
  }
  .modal-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 15px; text-align: center; color: #ffc107; }
  
  /* FORM */
  .form-group { margin-bottom: 12px; }
  label { display: block; margin-bottom: 5px; font-weight: bold; color: #aaa; }
  input, select {
    width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #555;
    background: #333; color: #fff; font-size: 1rem; box-sizing: border-box;
  }
  
  /* NEW INPUT LOGIC */
  .new-input-wrapper { display: none; margin-top: 5px; display: flex; gap: 5px; }
  .new-input-wrapper input { flex-grow: 1; }
  .ok-btn { background: #28a745; color: white; border: none; padding: 0 15px; border-radius: 6px; cursor: pointer; }

  /* BUTTONS */
  .btn-row { display: flex; gap: 10px; margin-top: 20px; justify-content: center; }
  .btn { padding: 12px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; flex: 1; }
  .btn-green { background: #28a745; color: #fff; }
  .btn-blue { background: #007bff; color: #fff; }
  .btn-red { background: #dc3545; color: #fff; }
  .btn:active { opacity: 0.8; }

  /* CONTROLS */
  #controls { 
    position: fixed; bottom: 0; left: 0; width: 100%; 
    background: #000; z-index: 1000; padding: 10px 0; 
    border-top: 1px solid #333;
    padding-bottom: env(safe-area-inset-bottom);
    display: flex; flex-wrap: wrap; justify-content: center; gap: 8px;
  }
  button.main-btn { 
    width: 45%; max-width: 180px; padding: 12px; font-size: 1rem; 
    border: none; border-radius: 8px; cursor: pointer; font-weight: bold; 
  }
  button.full-width { width: 92%; max-width: 380px; }
  #flash-btn { display: none; } 

  #scanner { width: 100%; display: none; z-index: 1; }
  #notification {
    position: fixed; top: 30px; left: 50%; transform: translateX(-50%);
    width: 90%; font-size: 2rem; font-weight: bold; text-align: center;
    opacity: 0; transition: opacity 0.2s; pointer-events: none; z-index: 2000; 
    text-shadow: 0px 3px 8px black;
  }
  .success-text { color: #00ff00; } 
  .error-text   { color: #ff3333; } 
  .info-text    { color: #007bff; font-size: 1.5rem; }
</style>
</head>

<body>

<div id="notification"></div>
<div id="scanner"><div id="reader"></div></div>

<div id="unknown-modal" class="modal-overlay">
  <div class="modal-box" style="text-align: center;">
    <div class="modal-title">Unknown Barcode</div>
    <p id="unknown-code-display" style="font-family: monospace; font-size: 1.2rem; color: #fff; margin-bottom: 20px;"></p>
    <div class="btn-row">
      <button class="btn btn-blue" onclick="closeModals()">Scan Again</button>
      <button class="btn btn-green" onclick="openAddForm()">Add New Filament</button>
    </div>
  </div>
</div>

<div id="add-form-modal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-title">Add New Filament</div>
    
    <div class="form-group">
      <label>Barcode</label>
      <input type="text" id="new-barcode" readonly style="background:#444; color:#aaa;">
    </div>

    <div class="form-group">
        <label>Brand</label>
        <select id="sel-brand" onchange="checkNew('brand')"></select>
        <div id="inp-brand-wrap" class="new-input-wrapper" style="display:none;">
            <input type="text" id="inp-brand"><button class="ok-btn" onclick="confirmNew('brand')">OK</button>
        </div>
    </div>
    
    <div class="form-group">
        <label>Material</label>
        <select id="sel-material" onchange="onMaterialChange()"></select>
        <div id="inp-material-wrap" class="new-input-wrapper" style="display:none;">
            <input type="text" id="inp-material"><button class="ok-btn" onclick="confirmNew('material')">OK</button>
        </div>
    </div>
    
    <div class="form-group">
        <label>Type</label>
        <select id="sel-type" onchange="onTypeChange()"></select>
        <div id="inp-type-wrap" class="new-input-wrapper" style="display:none;">
            <input type="text" id="inp-type"><button class="ok-btn" onclick="confirmNew('type')">OK</button>
        </div>
    </div>
    
    <div class="form-group">
        <label>Color</label>
        <select id="sel-color" onchange="checkNew('color')"></select>
        <div id="inp-color-wrap" class="new-input-wrapper" style="display:none;">
            <input type="text" id="inp-color"><button class="ok-btn" onclick="confirmNew('color')">OK</button>
        </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-red" onclick="closeModals()">Cancel</button>
      <button class="btn btn-green" onclick="saveNewProduct()">Done</button>
    </div>
  </div>
</div>

<div id="controls">
  <button class="main-btn" id="flash-btn" onclick="toggleFlash()" style="background:#555; color:#fff;">ðŸ”¦ Light</button>
  <button class="main-btn" onclick="switchCamera()" style="background:#6f42c1; color:#fff;">ðŸ“· Switch Cam</button>
  <button class="main-btn full-width" id="btn-scan-toggle" onclick="toggleScan()" style="background:#28a745; color:#fff;">â–¶ Start Scanning</button>
  <button class="main-btn" onclick="clearInventory()" style="background:#dc3545; color:#fff;">ðŸ§¹ Clear</button>
  <button class="main-btn" onclick="openInventory()" style="background:#007bff; color:#fff;">ðŸ“‹ View</button>
</div>

<script>
const SCRIPT = "https://script.google.com/macros/s/AKfycbySceeS-1b8bQ-RQXICYU-flzVlvCwSSBLXI-7Tyq1ct60QN1AcnvXqEPaig4xWo6cC/exec";
const INVENTORY = "https://docs.google.com/spreadsheets/d/1JGgkmJw-ZomVjKmLauKJ8V070_Vhx-97WvdhHLCJrmc/edit";
const PRODUCTS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWWQ0TK82bgpkiJkrj71ZXODJ7nnlyvSBKmlYJhEoF3JCgfkSy0_Wjjxlw_g-JQIDiDvANZ-p7HXUa/pub?gid=1242803893&single=true&output=csv";

let products = {};
let uniqueData = { brands: new Set(), materials: new Set(), types: new Set(), colors: new Set() };
let typesByMaterial = {}; 
let colorsByMatType = {}; 

let scanner = null;
let locked = false;
let audioCtx = null;
let isFlashOn = false; 
let isScanning = false;
let cameras = [];      
let currentCamIndex = 0; 

// --- 1. DATA LOADING ---
fetch(PRODUCTS_URL + "&t=" + Date.now()).then(r => r.text()).then(t => {
    const rows = t.split("\n").slice(1);
    let count = 0;
    rows.forEach(row => {
      const cols = row.split(",");
      if (cols.length > 4) {
        const barcode = clean(cols[0]);
        const brand = clean(cols[1]); const material = clean(cols[2]); const type = clean(cols[3]); const color = clean(cols[4]);
        if (barcode) { 
          products[barcode] = { brand, material, type, color };
          count++; 
          if(brand) uniqueData.brands.add(brand); if(material) uniqueData.materials.add(material);
          if(type) uniqueData.types.add(type); if(color) uniqueData.colors.add(color);

          if(material) {
             if (!typesByMaterial[material]) typesByMaterial[material] = new Set();
             if (type) {
                 typesByMaterial[material].add(type);
                 const key = material + "|" + type;
                 if (!colorsByMatType[key]) colorsByMatType[key] = new Set();
                 if (color) colorsByMatType[key].add(color);
             }
          }
        }
      }
    });
    console.log("Loaded", count);
});

function clean(str) {
  if (!str) return "";
  str = String(str).trim();
  if (str.startsWith('"') && str.endsWith('"')) str = str.slice(1, -1);
  return str.trim();
}

// --- 2. MODAL LOGIC ---
function showUnknownModal(code) {
  locked = true; 
  document.getElementById("unknown-code-display").textContent = code;
  document.getElementById("unknown-modal").style.display = "flex";
}

function closeModals() {
  document.getElementById("unknown-modal").style.display = "none";
  document.getElementById("add-form-modal").style.display = "none";
  locked = false; 
  startScanner(); 
}

function openAddForm() {
  document.getElementById("unknown-modal").style.display = "none";
  document.getElementById("add-form-modal").style.display = "flex";
  
  const code = document.getElementById("unknown-code-display").textContent;
  document.getElementById("new-barcode").value = code;

  document.querySelectorAll('.new-input-wrapper').forEach(el => el.style.display = 'none');
  document.querySelectorAll('select').forEach(el => el.style.display = 'block');

  populateSelect("sel-brand", uniqueData.brands);
  populateSelect("sel-material", uniqueData.materials);
  populateSelect("sel-type", new Set()); 
  populateSelect("sel-color", new Set());
}

function populateSelect(id, set) {
  const sel = document.getElementById(id);
  sel.innerHTML = "<option value='' disabled selected>Select...</option>";
  
  let newOpt = document.createElement("option");
  newOpt.value = "NEW"; newOpt.text = "âž• New..."; newOpt.style.color = "#28a745"; newOpt.style.fontWeight = "bold";
  sel.appendChild(newOpt);

  Array.from(set).sort().forEach(val => {
    let opt = document.createElement("option"); opt.value = val; opt.text = val; sel.appendChild(opt);
  });
}

function onMaterialChange() {
    const mat = document.getElementById("sel-material").value;
    checkNew('material');
    if (mat && mat !== "NEW") {
        const types = typesByMaterial[mat] || new Set(); populateSelect("sel-type", types);
    } else if (mat === "NEW") {
        populateSelect("sel-type", uniqueData.types);
    }
    populateSelect("sel-color", new Set());
}

function onTypeChange() {
    const mat = document.getElementById("sel-material").value;
    const type = document.getElementById("sel-type").value;
    checkNew('type');
    if (mat && type && mat !== "NEW" && type !== "NEW") {
        const key = mat + "|" + type; const colors = colorsByMatType[key] || new Set(); populateSelect("sel-color", colors);
    } else if (type === "NEW") {
        populateSelect("sel-color", uniqueData.colors);
    }
}

function checkNew(field) {
  const sel = document.getElementById("sel-" + field);
  const wrap = document.getElementById("inp-" + field + "-wrap");
  if (sel.value === "NEW") { sel.style.display = "none"; wrap.style.display = "flex"; document.getElementById("inp-" + field).focus(); }
}

function confirmNew(field) {
  const inp = document.getElementById("inp-" + field);
  const sel = document.getElementById("sel-" + field);
  const wrap = document.getElementById("inp-" + field + "-wrap");
  
  const newVal = clean(inp.value);
  if (newVal) {
    let opt = document.createElement("option"); opt.value = newVal; opt.text = newVal; sel.appendChild(opt); sel.value = newVal;
    if(field === 'material') populateSelect("sel-type", uniqueData.types);
    if(field === 'type') populateSelect("sel-color", uniqueData.colors);
  } else {
    sel.selectedIndex = 0; 
  }
  inp.value = ""; wrap.style.display = "none"; sel.style.display = "block";
}

function saveNewProduct() {
  const barcode = document.getElementById("new-barcode").value;
  const brand = document.getElementById("sel-brand").value;
  const material = document.getElementById("sel-material").value;
  const type = document.getElementById("sel-type").value;
  const color = document.getElementById("sel-color").value;

  if (brand === "NEW" || !brand || !material || !type || !color) { alert("Please fill in all fields."); return; }

  products[barcode] = { brand, material, type, color };
  if(!typesByMaterial[material]) typesByMaterial[material] = new Set();
  typesByMaterial[material].add(type);
  const key = material + "|" + type;
  if(!colorsByMatType[key]) colorsByMatType[key] = new Set();
  colorsByMatType[key].add(color);

  const url = `${SCRIPT}?action=add_product` +
              `&barcode=${encodeURIComponent(barcode)}` +
              `&brand=${encodeURIComponent(brand)}` +
              `&material=${encodeURIComponent(material)}` +
              `&type=${encodeURIComponent(type)}` +
              `&color=${encodeURIComponent(color)}`;
  
  fetch(url, { mode: "no-cors" });
  showNotification("Added to Inventory!", "success-text");
  closeModals();
}

// --- 3. SCANNER LOGIC ---
Html5Qrcode.getCameras().then(devices => {
  cameras = devices;
  if (cameras.length > 3) currentCamIndex = 3; 
  else if (cameras.length > 0) currentCamIndex = cameras.length - 1; 
}).catch(err => console.log("Cam error", err));

function toggleScan() { if (isScanning) stopScanner(); else startScanner(); }

function startScanner() {
  document.getElementById("scanner").style.display = "block";
  if (!audioCtx) try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {} 
  if (!scanner) scanner = new Html5Qrcode("reader");

  const config = { fps: 30, qrbox: { width: 250, height: 100 } };
  const camId = (cameras.length > 0) ? cameras[currentCamIndex].id : { facingMode: "environment" };

  isFlashOn = false;
  updateFlashBtn();
  updateFlashVisibility();

  scanner.start(camId, config, onScan).then(() => {
    isScanning = true;
    document.getElementById("btn-scan-toggle").innerHTML = "â¹ Stop Camera";
    document.getElementById("btn-scan-toggle").style.background = "#dc3545"; 
  }).catch(err => alert("Start Failed: " + err));
}

function stopScanner() {
  if (scanner && isScanning) {
    scanner.stop().then(() => {
      scanner.clear(); isScanning = false;
      document.getElementById("btn-scan-toggle").innerHTML = "â–¶ Start Scanning";
      document.getElementById("btn-scan-toggle").style.background = "#28a745"; 
      document.getElementById("scanner").style.display = "none";
      document.getElementById("flash-btn").style.display = "none";
    });
  }
}

function switchCamera() {
  if (cameras.length < 2) { showNotification("Only 1 Cam Found", "error-text"); return; }
  currentCamIndex = (currentCamIndex + 1) % cameras.length;
  updateFlashVisibility();
  if (isScanning) {
    scanner.stop().then(() => {
       scanner.clear(); isScanning = false; setTimeout(() => { startScanner(); }, 200);
    }).catch(err => startScanner());
  } else {
     let label = cameras[currentCamIndex].label || `Cam ${currentCamIndex}`;
     showNotification("Selected: " + label.split('(')[0], "info-text");
  }
}

function updateFlashVisibility() {
    if (currentCamIndex === 3) document.getElementById("flash-btn").style.display = "block";
    else document.getElementById("flash-btn").style.display = "none";
}

function toggleFlash() {
  const video = document.querySelector("#scanner video");
  if (!video || !video.srcObject) return;
  const track = video.srcObject.getVideoTracks()[0];
  isFlashOn = !isFlashOn;
  track.applyConstraints({ advanced: [{ torch: isFlashOn }] }).then(() => updateFlashBtn())
  .catch(() => { track.applyConstraints({ torch: isFlashOn }).then(() => updateFlashBtn()); });
}

function updateFlashBtn() {
    const btn = document.getElementById("flash-btn");
    if (isFlashOn) { btn.innerHTML = "ðŸ”¦ Light: ON"; btn.style.background = "#ffc107"; btn.style.color = "#000"; }
    else { btn.innerHTML = "ðŸ”¦ Light"; btn.style.background = "#555"; btn.style.color = "#fff"; }
}

function onScan(code) {
  if (locked) return;
  code = clean(code);
  let item = products[code];
  if (!item) item = products["0" + code];
  if (!item && code.startsWith("0")) item = products[code.substring(1)];

  if (!item) {
    beep();
    showUnknownModal(code);
    return;
  }
  locked = true;
  beep();
  showNotification(item.color, "success-text");

  const url = `${SCRIPT}?barcode=${encodeURIComponent(code)}` +
              `&color=${encodeURIComponent(item.color)}` +
              `&brand=${encodeURIComponent(item.brand)}` +
              `&material=${encodeURIComponent(item.material)}` +
              `&type=${encodeURIComponent(item.type)}`;
  fetch(url, { mode: "no-cors" });
  setTimeout(() => { locked = false; }, 1500);
}

function beep() { try { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === "suspended") audioCtx.resume(); const o = audioCtx.createOscillator(); o.frequency.value = 1000; const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + 0.15); } catch (e) {} }

function showNotification(msg, cssClass) { const el = document.getElementById("notification"); el.textContent = msg; el.style.opacity = "1"; el.className = cssClass; setTimeout(() => { el.style.opacity = "0"; }, 2000); }

function clearInventory() { if (confirm("Clear inventory?")) { fetch(`${SCRIPT}?action=clear`, { mode: "no-cors" }); showNotification("Inventory Cleared", "success-text"); } }
function openInventory() { window.open(INVENTORY, "_blank"); }
</script>
</body>
</html>
